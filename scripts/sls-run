#!/bin/bash

set -e

if [ -z $PLUGIN_ROLE ];
then
    echo "Error: please provide aws role to assume"
    exit 1
fi

if [ -z $PLUGIN_STAGE ];
then
    echo "Error: please provide deployment stage"
    exit 1
fi

if [ -z $PLUGIN_REGION ];
then
    echo "Error: please provide aws region "
    exit 1
fi

echo "Assuming: ${PLUGIN_ROLE}"
CREDS=`aws sts assume-role --role-arn ${PLUGIN_ROLE} --role-session-name=${DRONE_REPO_OWNER}-${DRONE_REPO_NAME}`

export AWS_ACCESS_KEY_ID=`echo $CREDS | jq -r '.Credentials.AccessKeyId'`
export AWS_SECRET_ACCESS_KEY=`echo $CREDS | jq -r '.Credentials.SecretAccessKey'`
export AWS_SESSION_TOKEN=`echo $CREDS | jq -r '.Credentials.SessionToken'`

USER=`aws sts get-caller-identity |  jq -r '.Arn'`
echo "Assumed: $USER"

if [ -f "./node_modules/.bin/sls" ]
then
    COMMAND="./node_modules/.bin/sls"
else
    COMMAND="sls"
fi

echo "using sls version `${COMMAND} --version`"

if [ "$PLUGIN_CREATE_DOMAIN" = "true" ] 
then

    set -x
    ${COMMAND} create_domain -s ${PLUGIN_STAGE} -r ${PLUGIN_REGION} -x
    set +x
fi

if [ "$PLUGIN_ACTION" = "deploy" ] 
then
    ARGS=""
    if [ "$PLUGIN_CONCEAL" = "true" ] 
    then
        ARGS="$ARGS --conceal"
    fi

    if [ "$PLUGIN_ACCELERATE" = "true" ] 
    then
        ARGS="$ARGS --aws-s3-accelerate"
    fi

    set -x
    ${COMMAND} deploy ${ARGS} -s ${PLUGIN_STAGE} -r ${PLUGIN_REGION} -v
    ${COMMAND} info ${ARGS} -s ${PLUGIN_STAGE} -r ${PLUGIN_REGION} -v
    set +x
    
fi

